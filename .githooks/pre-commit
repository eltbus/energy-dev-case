#!/bin/bash

# Check if there are any changes in the working directory
if ! git diff-index --quiet HEAD --; then
  # If there are changes, stash any unstaged changes
  git stash -q --keep-index

  # Run tests on all changes
  make test

  # Save exit code of the test
  exit_code=$?

  # Pop the stash to restore unstaged changes
  git stash pop -q
else
  # If there are no changes, run `make test` directly
  make test

  # Save exit code of the test
  exit_code=$?
fi

# If the tests fail, abort the commit
if [ $exit_code -ne 0 ]; then
  echo "Tests failed. Aborting commit."
  exit 1
fi
